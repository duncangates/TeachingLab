---
title: "Example Report"
author: "Teaching Lab Monthly Facilitator Review"
date: "Sys.Date()"
output: 
  rmdformats::readthedown:
    css: styles.css
    self_contained: true # Other options are downcute, material, readthedown, html_clean, html_docco, lockdown, https://github.com/juba/rmdformats
    thumbnails: false
    lightbox: true
    gallery: false
    highlight: kate # Also can do tango
    number_sections: false
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(tidyverse)
library(lubridate)
library(ggiraph)
library(gt)
library(reactable)
library(reactablefmtr)
library(scales)
library(htmltools)
library(htmlwidgets)
library(glue)
library(here)
sheets_data <- read_rds(here("Data/google_sheets_data.rds"))

col <- colorRampPalette(c("#040404", "#04ABEB"))
```

```{r echo = F}
# htmltools::tagList(rmarkdown::html_dependency_font_awesome()) # Needed so fa's in footer will show
```

# List of Report Types

- Snapshot of all PL work (for our team, funders, board, website, impact report)

- Facilitator report (only has data for that facilitator) - does not include NPS

- Report comparing all facilitators (for facilitator development)

# Example of a Plot

Note that I could add interactivity here for each point so that when you hover you can see what the response to any given question associated with the point is.

```{r}
# All time plot
sheets_data %>%
  drop_na(`Select the name of your first facilitator.`) %>%
  mutate(`Select the name of your first facilitator.` = str_replace(`Select the name of your first facilitator.`,
                                                                    "Ryan Mateo Sharnbroich",
                                                                    "Ryan Sharnbroich")) %>%
  ggplot(aes(x = `Select the name of your first facilitator.`, 
                               y = `How likely are you to recommend this professional learning to a colleague or friend?`)) +
  geom_boxplot(alpha = 0) +
  geom_jitter(alpha = 0.3, width = 0.15, aes(color = `Select the name of your first facilitator.`)) +
  coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_manual(values = col(length(unique(sheets_data$`Select the name of your first facilitator.`)))) +
  labs(x = "", title = "Each Facilitator's Scores All Time") +
  theme_minimal() + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(family = "Open Sans"),
        plot.title = element_text(hjust = 0.5))

# Just this month plot
sheets_data %>%
  drop_na(`Select the name of your first facilitator.`) %>%
  mutate(`Select the name of your first facilitator.` = str_replace(`Select the name of your first facilitator.`,
                                                                    "Ryan Mateo Sharnbroich",
                                                                    "Ryan Sharnbroich"),
         Month = lubridate::month(Date, label = T),
         Month2 = lubridate::month(Date)) %>%
  filter(Month2 == month(Sys.Date())) %>% # Filter for current month
  ggplot(aes(x = `Select the name of your first facilitator.`, 
                               y = `How likely are you to recommend this professional learning to a colleague or friend?`)) +
  geom_boxplot(alpha = 0) +
  geom_jitter(alpha = 0.7, width = 0.15, aes(color = `Select the name of your first facilitator.`)) +
  coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_manual(values = col(length(unique(sheets_data$`Select the name of your first facilitator.`)))) +
  labs(x = "", title = glue::glue("Each Facilitator's Scores in the Month of {month(Sys.Date(), label = T, abbr = F)}")) +
  theme_minimal() + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(family = "Open Sans", color = "black"),
        axis.text = element_text(color = "black"),
        plot.title = element_text(hjust = 0.5))
ggsave(here(paste0("Images/", "facilitator_", month(Sys.Date(), abbr = F, label = T), "_plot.png")), width = 16, height = 9)
```

# Example of a Table

```{r}
survey_responses <- sheets_data %>%
  select(`How likely are you to recommend this professional learning to a colleague or friend?`, 
         `Why did you choose this rating?`, 
         `What could have improved your experience?`,
         `Select your course.`,
         `Date`,
         `Select the name of your first facilitator.`) %>%
  drop_na(`How likely are you to recommend this professional learning to a colleague or friend?`) %>%
  mutate(Date = format(`Date`, '%b, %d %Y')) %>%
  dplyr::arrange(desc(`How likely are you to recommend this professional learning to a colleague or friend?`))
  
survey_responses %>%
  filter(`How likely are you to recommend this professional learning to a colleague or friend?` < 3) %>%
  gt() %>%
  tab_header(
    title = md("&#129440; **Reviews with Scores Less than 3** &#129440;"),
    subtitle = md("Sorted *Best-Worst:* Of which there are only 37!")
  ) %>%
  cols_width(
    vars(`How likely are you to recommend this professional learning to a colleague or friend?`) ~ px(110),
         everything() ~ px(250)
  ) %>%
  cols_label(
    `How likely are you to recommend this professional learning to a colleague or friend?` = md("**Likeliness to Recommend**"),
    `Why did you choose this rating?` = md("**Why did you choose this rating?**"), 
    `What could have improved your experience?` = md("**What could have improved your experience?**"),
    `Select your course.` = md("**Professional training session**"),
    Date = md("**Date**"),
    `Select the name of your first facilitator.` = md("**Facilitator**")
  ) %>%
  cols_align(
    align = "center",
    columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`)
  ) %>%
  data_color(columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`),
             colors = scales::col_numeric(
               palette = col(nrow(survey_responses))
               %>% as.character(),
             domain = NULL)
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "right",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`)
      )
    )
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "right",
        color = "gray50",
        weight = px(1.5)
      )
    ),
    locations = list(
      cells_body(
        columns = vars(`What could have improved your experience?`, `Why did you choose this rating?`, 
                       `Select your course.`, `Select the name of your first facilitator.`)
      )
    )
  ) %>%
  tab_options(
    summary_row.background.color = "#ACEACE80",
    grand_summary_row.background.color = "#990000",
    row_group.background.color = "#FFEFDB80",
    heading.background.color = "#04ABEB", # Main Heading Background
    column_labels.background.color = "#EFFBFC",
    stub.background.color = "#EFFBFC",
    table.font.color = "#323232",
    table.font.names = "Oswald",
    table_body.hlines.color = "#989898",
    table_body.border.top.color = "#989898",
    heading.border.bottom.color = "#989898",
    row_group.border.top.color = "#989898",
    row_group.border.bottom.style = "none",
    stub.border.style = "dashed",
    stub.border.color = "#989898",
    stub.border.width = "1px",
    summary_row.border.color = "#989898")
```

## Example of a Sub Heading: An Even More Filtered Table

```{r}
survey_responses %>%
  dplyr::filter(`How likely are you to recommend this professional learning to a colleague or friend?` < 3 &
         !str_detect(`Why did you choose this rating?`, "NULL|N/A") == T) %>%
  gt() %>%
  tab_header(
    title = md("&#129440; **Reviews with Scores Less than 3** &#129440;"),
    subtitle = md("Sorted *Best-Worst:* Getting Rid of NA Responses")
  ) %>%
  cols_width(
    vars(`How likely are you to recommend this professional learning to a colleague or friend?`) ~ px(110),
         everything() ~ px(250)
  ) %>%
  cols_label(
    `How likely are you to recommend this professional learning to a colleague or friend?` = md("**Likeliness to Recommend**"),
    `Why did you choose this rating?` = md("**Why did you choose this rating?**"), 
    `What could have improved your experience?` = md("**What could have improved your experience?**"),
    `Select your course.` = md("**Professional training session**"),
    Date = md("**Date**"),
    `Select the name of your first facilitator.` = md("**Facilitator**")
  ) %>%
  cols_align(
    align = "center",
    columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`)
  ) %>%
  data_color(columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`),
             colors = scales::col_numeric(
               palette = col(nrow(survey_responses))
               %>% as.character(),
             domain = NULL)
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "right",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = vars(`How likely are you to recommend this professional learning to a colleague or friend?`)
      )
    )
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "right",
        color = "gray50",
        weight = px(1.5)
      )
    ),
    locations = list(
      cells_body(
        columns = vars(`What could have improved your experience?`, `Why did you choose this rating?`, 
                       `Select your course.`, `Select the name of your first facilitator.`)
      )
    )
  ) %>%
  tab_options(
    summary_row.background.color = "#ACEACE80",
    grand_summary_row.background.color = "#990000",
    row_group.background.color = "#FFEFDB80",
    heading.background.color = "#04ABEB", # Main Heading Background
    column_labels.background.color = "#EFFBFC",
    stub.background.color = "#EFFBFC",
    table.font.color = "#323232",
    table.font.names = "Oswald",
    table_body.hlines.color = "#989898",
    table_body.border.top.color = "#989898",
    heading.border.bottom.color = "#989898",
    row_group.border.top.color = "#989898",
    row_group.border.bottom.style = "none",
    stub.border.style = "dashed",
    stub.border.color = "#989898",
    stub.border.width = "1px",
    summary_row.border.color = "#989898")
```

# Example with Summary Statistics

```{r}
numeric_averages <- sheets_data %>%
  mutate(Month = lubridate::month(Date, label = T, abbr = F)) %>%
  group_by(Month) %>%
  select(-`How likely are you to recommend this professional learning to a colleague or friend?`) %>%
  summarise(across(where(is.numeric), ~ round(length(which(.x %in% c(4, 5)))/length(.x), 4))) %>%
  select(-`S/he effectively built a community of learners #3`, -`S/he facilitated the content clearly #3`) %>%
  arrange(Month) %>%
  mutate(`S/he facilitated the content clearly` = round((`S/he facilitated the content clearly #1` + `S/he facilitated the content clearly #2`)/2, 2),
         `S/he effectively built a community of learners` = round((`S/he effectively built a community of learners #1` + `S/he effectively built a community of learners #2`)/2, 2)) %>%
  select(-`S/he effectively built a community of learners #1`, -`S/he effectively built a community of learners #2`,
         -`S/he facilitated the content clearly #1`, -`S/he facilitated the content clearly #2`)

nps_average <- sheets_data %>%
  mutate(Month = lubridate::month(Date, label = T, abbr = F)) %>%
  select(Month, `How likely are you to recommend this professional learning to a colleague or friend?`) %>%
  group_by(Month) %>%
  summarise(NPS = round(((length(which(`How likely are you to recommend this professional learning to a colleague or friend?` %in% c(9, 10)))/
                           length(`How likely are you to recommend this professional learning to a colleague or friend?`)) -
                          (length(which(`How likely are you to recommend this professional learning to a colleague or friend?` %in% c(0:6)))/
                           length(`How likely are you to recommend this professional learning to a colleague or friend?`)))*100, 2))
# numeric_average <- round(colMeans(numeric_averages[-1], na.rm = T), 2)
# numeric_average <- purrr::prepend(numeric_average, list("Month" = "Average"))
# numeric_averages <- bind_rows(numeric_averages, numeric_average)
numeric_averages <- left_join(numeric_averages, nps_average, by = c("Month")) %>%
  mutate(Month = factor(Month, levels = c("July", "August", "September", "October", "November", "December", "January", "February", "March", "April", "May", "June"))) %>%
  arrange(Month)
```

```{css, echo = FALSE}
.border-left {
  border-left: 2px solid #555;
}

.border-right {
  border-right: 2px solid #555;
}

.monthly-tbl {
  font-family: "Josef Xuereb's Friends";
}

.example-title {
  margin-top: 3px;
  padding: -10px;
  font-size: 20px;
}
```

```{r reactable}
numeric_reactable <- reactable::reactable(numeric_averages,
                                          # Add theme for the top border
                                          theme = reactableTheme(
                                            # style = list(fontFamily = "Open Sans Light Italic"),
                                            headerStyle = list(
                                              "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
                                              "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
                                              borderColor = "#555"
                                            ),
                                            footerStyle = list(
                                              "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
                                              "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
                                              borderColor = "#555"
                                            )
                                          ),
                                          columns = list(
                                            Month = colDef(footer = "Average",
                                                           # Add border to right of column
                                                           class = "border-right",
                                                           width = 100,
                                                           style = list(fontWeight = "bold")),
                                            `I am satisfied with the overall quality of this course.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`I am satisfied with the overall quality of this course.`)*100, 2), "%")),
                                            `The topics for this course were relevant for my role.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`The topics for this course were relevant for my role.`)*100, 2), "%")),
                                            `The independent online work activities were well-designed to help me meet the learning targets.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`The independent online work activities were well-designed to help me meet the learning targets.`)*100, 2), "%")),
                                            `The Zoom course activities were well-designed to help me meet the learning targets.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`The Zoom course activities were well-designed to help me meet the learning targets.`)*100, 2), "%")),
                                            `I felt a sense of community with the other participants in this course even though we were virtual.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`I felt a sense of community with the other participants in this course even though we were virtual.`)*100, 2), "%")),
                                            `This course helped me navigate remote and/or hybrid learning during COVID-19.` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`This course helped me navigate remote and/or hybrid learning during COVID-19.`)*100, 2), "%")),
                                            `How likely are you to apply this learning to your practice in the next 4-6 weeks?` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`How likely are you to apply this learning to your practice in the next 4-6 weeks?`)*100, 2), "%")),
                                            `How likely are you to recommend this professional learning to a colleague or friend?` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`How likely are you to recommend this professional learning to a colleague or friend?`)*100, 2), "%")),
                                            `S/he facilitated the content clearly` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`S/he facilitated the content clearly`)*100, 2), "%")),
                                            `S/he effectively built a community of learners` = 
                                              colDef(footer = paste0(round(mean(numeric_averages$`S/he effectively built a community of learners`)*100, 2), "%")),
                                            NPS =
                                              colDef(cell = data_bars_gradient(numeric_averages, 
                                                                               colors = rev(col(10))),
                                                     footer = round(mean(numeric_averages$NPS), 2),
                                                     style = list(backgroundColor = "white",
                                                                  fontWeight = "bold"),
                                                     width = 120,
                                                     class = "border-left")
                                          ),
  defaultColDef = colDef(cell = color_tiles(data = numeric_averages, colors = col(5)[3:5], number_fmt = scales::percent),
                         format = colFormat(percent = T, digits = 2),
                         footerStyle = list(fontWeight = "bold"),
                         headerClass = "average-score-header", align = "center"),
  highlight = T,
  compact = T,
  borderless = F,
  class = "monthly-tbl"
)

div(class = "example",
  div(class = "example-header",
      div(class = "example-title", HTML("<center><h1 style='color:#045777;background-color: hsl(205, 100%, 36%);color: hsl(0, 0%, 20%);font-family: 'Josef Xuereb's Friends';padding-top:0px;margin: 0px;'>Percent that Agree/Strongly Agree w/ Statements Per Month</h1></center>")),
      numeric_reactable
  )
)
```

```{r eval = F}
saveWidget(widget = numeric_reactable, file = here("HTML/monthly_table.html"), selfcontained = T)
save_html(html = numeric_reactable, file = here("HTML/monthly_table.html"))
webshot2::webshot(url = here("HTML/monthly_table.html"),
                  file = here("Images/monthly_table.png"), vwidth = 900, vheight = 1200, delay = 3)
```

## NPS Score testing

```{r}
test <- teaching_df %>%
        # dplyr::filter(between(`Date for the session`, input$date[1], input$date[2])) %>%
        group_by(`Date for the session`) %>%
        summarise(Mean = mean(`How likely are you to recommend this professional learning to a colleague or friend?`, na.rm = T)) %>%
  drop_na()
test %>%
  ggplot(aes(x = factor(`Date for the session`), y = Mean)) +
  geom_col() +
  theme_minimal()
```

## Time series testing

```{r}
test <- teaching_df %>%
  # dplyr::filter(between(`Date for the session`, input$date[1], input$date[2])) %>%
  group_by(`The activities of today's session were well-designed to help me learn.`, `Date for the session`) %>%
  summarise(`Number Agree/Disagree` = n()) %>%
  drop_na() %>%
  # group_by(`Date for the session`) %>%
  # mutate(Percent = round(`Number Agree/Disagree`/sum(`Number Agree/Disagree`) * 100, 2)) %>%
  # select(`Date for the session`, Percent, `The activities of today's session were well-designed to help me learn.`) %>%
  # relocate(Percent, .after = last_col()) %>%
  # arrange(desc(`Date for the session`))
  # pivot_wider(names_from = "The activities of today's session were well-designed to help me learn.", values_from = "Number Agree/Disagree",
  #             id_cols = "Date for the session") %>%
  # group_by(`Date for the session`) %>%
  # mutate(`Number Agree` = sum(Agree, `Strongly agree`, na.rm = T),
  #        `Number Disagree` = sum(`Neither agree nor disagree`, `Disagree`, `Strongly disagree`, na.rm = T)) %>%
  # mutate(`Percent Agree/Strongly Agree` = round(`Number Agree`/sum(`Number Agree` + `Number Disagree`)*100, 2),
  #        `Percent Neither/Disagree/Strongly Disagree` = round(`Number Disagree`/sum(`Number Agree` + `Number Disagree`)*100, 2)) %>%
  # select(`Date for the session`, `Percent Agree/Strongly Agree`, `Percent Neither/Disagree/Strongly Disagree`) %>%
  # pivot_longer(names_to = "Rating", values_to = "Percent", !`Date for the session`)
        mutate(Rating = case_when(`The activities of today's session were well-designed to help me learn.` %in% c("Agree", "Strongly agree") ~ "Good",
                                  `The activities of today's session were well-designed to help me learn.` %in% c("Neither agree nor disagree", "Disagree", "Strongly disagree") ~ "Bad")) %>%
  # group_by(`Date for the session`, Rating) %>%
        # pivot_wider(names_from = "Rating", values_from = "Number Agree/Disagree", id_cols = "Date for the session") #%>%
        group_by(`Date for the session`) %>%
        mutate(Percent = `Number Agree/Disagree`/sum(`Number Agree/Disagree`)*100) %>%
        # filter(Rating == "Good") %>%
        group_by(`Date for the session`, Rating) %>%
        summarise(Percent = round(sum(Percent), 2))
```

## Waffle chart testing

```{r}
test <- teaching_df %>%
  dplyr::group_by(`Today's topic was relevant for my role.`) %>% # Group by input variable
  dplyr::summarise(n = n()) %>% # Get count of variable
  ungroup() %>% # Ungroup
  dplyr::filter(`Today's topic was relevant for my role.` != "No Response") %>% # Filter out non-responses
  dplyr::mutate(percent = round(100 * (n / sum(n)), 2)) %>% # Make a percent column without non-responses
  dplyr::relocate(percent, .before = n)
ggplot(test, aes(values = n, fill = `Today's topic was relevant for my role.`)) +
          waffle::geom_waffle(n_rows = 100, colour = "white", flip = T) +
            scale_fill_manual(values = c(rev(col(nrow(test))))) + # custom colors
          labs(
            fill = "Type", x = NULL, y = NULL
          ) +
          coord_equal() +
          theme_void() +
          theme(
            legend.position = "top",
            legend.title = element_blank(),
            plot.title = element_text(hjust = 0.5, family = "Open Sans ExtraBold")
          )
```

## Tree map testing

```{r}
treemap::treemap(
          test,
          index = c("Today's topic was relevant for my role."),
          vSize = "n",
          type = "index",
          palette = "Blues",
          title = "asdasdfasa")
```

## Wordcloud testing

```{r}
teaching_df %>%
  select(`What could have improved your experience?`) %>%
      unnest_tokens(`What could have improved your experience?`, token = "words") %>%
      mutate(freq = n())
wordcloud2(text_viz_data(), n, col = col(nrow(text_viz_data())))
```

